<div class="list-container">

    <header class="page-header">
        <h1>Agenda de Agendamentos</h1>
        <button class="btn-primary btn-add" (click)="openAdminModal()">
            + Novo Agendamento
        </button>
    </header>

    <div class="calendar-header">
        <div class="btn-group">
            <button
                    class="btn-secondary"
                    (click)="setView(CalendarView.Month)"
                    [class.active]="view === CalendarView.Month">
                Mês
            </button>
            <button
                    class="btn-secondary"
                    (click)="setView(CalendarView.Week)"
                    [class.active]="view === CalendarView.Week">
                Semana
            </button>
            <button
                    class="btn-secondary"
                    (click)="setView(CalendarView.Day)"
                    [class.active]="view === CalendarView.Day">
                Dia
            </button>
        </div>
        <div class="btn-group">
            <button
                    class="btn-secondary"
                    mwlCalendarPreviousView
                    [view]="view"
                    [(viewDate)]="viewDate"
                    (viewDateChange)="onViewDateChange()">
                Anterior
            </button>
            <button
                    class="btn-secondary"
                    mwlCalendarToday
                    [(viewDate)]="viewDate"
                    (viewDateChange)="onViewDateChange()">
                Hoje
            </button>
            <button
                    class="btn-secondary"
                    mwlCalendarNextView
                    [view]="view"
                    [(viewDate)]="viewDate"
                    (viewDateChange)="onViewDateChange()">
                Próximo
            </button>
        </div>
        <h3>{{ viewDate | calendarDate:(view + 'ViewTitle'):locale }}</h3>
    </div>

    <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
    </div>

    <div *ngIf="isLoading" class="loading-indicator">
        Carregando agendamentos...
    </div>

    <div [ngSwitch]="view" class="calendar-container card">
        <mwl-calendar-month-view
                *ngSwitchCase="CalendarView.Month"
                [viewDate]="viewDate"
                [events]="events"
                [refresh]="refresh"
                [locale]="locale"
                (dayClicked)="setView(CalendarView.Day); viewDate = $event.day.date">
        </mwl-calendar-month-view>

        <mwl-calendar-week-view
                *ngSwitchCase="CalendarView.Week"
                [viewDate]="viewDate"
                [events]="events"
                [refresh]="refresh"
                [locale]="locale">
        </mwl-calendar-week-view>

        <mwl-calendar-day-view
                *ngSwitchCase="CalendarView.Day"
                [viewDate]="viewDate"
                [events]="events"
                [refresh]="refresh"
                [locale]="locale">
        </mwl-calendar-day-view>
    </div>
</div>


<div *ngIf="showAdminModal" class="modal-backdrop" (click)="closeAdminModal()"></div>

<div *ngIf="showAdminModal" class="modal-content">

    <div class="modal-header">
        <h2>Novo Agendamento (Admin)</h2>
        <button class="modal-close" (click)="closeAdminModal()" [disabled]="modalLoading">&times;</button>
    </div>

    <form (ngSubmit)="onAdminSubmit()">
        <div class="modal-body">

            <div class="form-group">
                <label for="cliente">Cliente:</label>
                <select id="cliente" [(ngModel)]="agendamentoForm.clienteId" name="cliente"
                        (change)="onClienteChange($event)" required>
                    <option value="" disabled>Selecione um cliente...</option>
                    <option *ngFor="let cliente of (clientes$ | async)" [value]="cliente.id">
                        {{ cliente.nome }}
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="pet">Pet:</label>
                <select id="pet" [(ngModel)]="agendamentoForm.petId" name="pet"
                        [disabled]="petsDoCliente.length === 0" required>
                    <option value="" disabled>Selecione um pet...</option>
                    <option *ngFor="let pet of petsDoCliente" [value]="pet.id">
                        {{ pet.nome }}
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="servicos">Serviços:</label>
                <select id="servicos" [(ngModel)]="agendamentoForm.servicoIds" name="servicos"
                        multiple required size="4">
                    <option *ngFor="let servico of (servicos$ | async)" [value]="servico.id">
                        {{ servico.nome }} ({{ servico.preco | currency:'BRL' }})
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="dataHora">Data e Hora:</label>
                <input type="datetime-local" id="dataHora" [(ngModel)]="agendamentoForm.dataHora"
                       name="dataHora" required />
            </div>

            <div *ngIf="modalError" class="modal-error-message">
                {{ modalError }}
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-secondary" (click)="closeAdminModal()" [disabled]="modalLoading">
                Cancelar
            </button>
            <button type="submit" class="btn-primary" [disabled]="modalLoading || !agendamentoForm.petId || agendamentoForm.servicoIds.length === 0">
                {{ modalLoading ? 'Salvando...' : 'Criar Agendamento' }}
            </button>
        </div>
    </form>
</div>